Code Grep and Vi Grepped
cg, vg - tools for finding and modifying on keywords
Joshua Uziel <juziel@home.com> - June 30, 1999 - version 1.2

All too often I need to dig through source code.  Where something
is defined, used, what files, etc.  There's a great tool for doing
this from AT&T called "cscope" and a very alpha free clone of it
called "cs" (that doesn't looks like it's being actively worked
on) that does this.  There are some alternatives... like ctags
and etags for instance... but these only take you to where something
is defined... not wherever it is used, which makes it frustrating
when, for example, you're at the definition of a function and
instead want to see who and what use that function.

So, as a quick hack, mostly for myself, I started writing up some 
perl scripts (I consciously chose perl, but considered other 
languages first).  One script, "cg", makes use of find and grep.
Run it like so:

[11:14pm] tux:/usr/src/linux/fs> cg ext2_permission
0 ext2/acl.c   22 * ext2_permission ()
1 ext2/acl.c   26 int ext2_permission (struct inode * inode, int mask)
2 ext2/dir.c   74 ext2_permission,        /* permission */
3 ext2/file.c 102 ext2_permission,        /* permission */

So, you see in the first column, we have a count, the second column
is the filename, the third column is the line number, and after that
is what it found on that line.  This gets stored in your home directory
as ~/.cglast, so that if you want to see it again, all you have to
do is type "cg" to view it again.  Also stored in the first line is
the pwd of where your inquiry was run from, so you that won't have
to be there to do the second half of this kit.

There are several ways of running "cg".  Again, "cg" alone recalls
the last search.  You can also run it like "cg pattern", and it'll
search recursively for all default patterns.  To that, you can add
some of grep(1)'s arguments like "-i" for case insensitive like
"cg -i pattern".  If you don't want to use the default searching,
you can specify where to search and run like grep(1).  For example,
running "cg pattern *.c" will check all .c files, and if you have
GNU grep v2.3 with the "-r" options, you can use it to search
recursively with something like "cg -r pattern *.c".  Note that
running it like this creates a significant amount of overhead, so
it's advisable to use the default search patterns when you can.

The other script is called "vg" and opens a vi on what has been grepped
(actually, it use "vi" or "vim").  So remember that count?  All you
have to do is run "vg count" and it'll fire off a vi in that file
and at that line number.  So, in our example, running "vg 1" would
open up a vi session on fs/ext2/acl.c at line 26.

It is the storing of the query in ~/.cglast that allows cg and vg
to work together.  Also, the reason for the ability to see the
results of the previous query is there because we can, and because
quite often you may want to revisit the last query, so why do an
expensive grep operation again?

Now true that these scripts are very much hacks, but they at least
provide me with the functionality that I was looking for in a very
smal amount of time.  They're not as feature-rich or precise as
cscope is, but at the same time are simple to use and are not
language-specific (cscope only knows C and not C++, java or perl
for example).

Used with something like ctags, this can hopefully save you a lot
of time.  Feel free to send me comments or suggestions...

----------------
REVISION HISTORY
----------------
June 30, 1999
1.2 -	More changes to the cg script.  Rather than simply print the
	logfile like previous versions, I actually attempt to make
	it human readable now.  The logfile keeps the same format,
	just what's printed to the screen has changed.  In doing this,
	though, there are a gotcha or two to watch for in how much
	of the string can be printed.  Also, I've made an attempt to
	have the program auto-detect the number of columns using
	"stty -a" rather than assuming 80 columns.  Switched to
	using "fgrep" instead of regular "grep", as it seemed more
	appropriate for this task.  Did some code cleanup in both
	cg and vg otherwise.  An environment variable, $CGEDITOR
	can be set for choosing an editor to use now.

	With this version, I'm close to probably as far as this
	may go (with the exceptions of patches and improvements).
	Future versions of this program will possibly just focus
	on cleanups from the current state.  Realistically, the
	next step is to make a real cscope clone.  It's often in
	the back of my mind, so feel free to contact me if you
	would like to discuss this possibility.

June 28, 1999
1.1 - 	Changed how the cg program works a bit.  Instead of having the
	user define the files to search in (*, *.c, *.java, etc.), it
	now has a list of files built-in.  This should decrease the
	overhead quite a bit (in not searching all files), allow for
	all versions of grep (instead of just GNU grep v2.3 and later),
	and cut an argument... none of the flexibility is lost, and
	it's actually advisable to avoid the mode where you specify
	the files to search for as a huge overhead reduction in the
	program's runtime.  The use of arguments for find(1) chosen 
	are also done so that non-GNU versions of it can be used, and 
	I use Perl to do some cleanup.

	The vg script has also been modified to support both "vim"
	and regular "vi".  Before, I was executing "vim path/file +line",
	and instead now am running "vi +line path/file", which is
	how both traditional vi's and vim can handle it.  All in all,
	these scripts will work fine on both the Linux and Solaris
	machines I have tested on (both GNU and non-GNU tools).

	Renamed "rg" to "cg", as the name seemed more appropriate.

June 8, 1999
1.0 -	Initial release.  Requires GNU grep v2.3 or later, and is a
	bit of a dog to run... but hey, it does what it's supposed to
	do, so I'm happy for now.  Scripts are "rg" and "vg".
